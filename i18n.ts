import React, { createContext, useState, useContext, ReactNode, FC } from 'react';

type Language = 'en' | 'ar';

interface LanguageContextType {
  language: Language;
  setLanguage: (language: Language) => void;
  t: (key: string, options?: Record<string, string | number>) => string;
}

const translations: Record<Language, Record<string, string>> = {
  en: {
    // General
    appTitle: 'Procurement System',
    shortAppTitle: 'EWAA HOTELS',
    selectRole: 'Please select your role to login',
    request: 'Request',
    requests: 'Requests',
    requester: 'Requester',
    total: 'Total',
    currency: 'SAR',
    perUnit: 'per unit',
    items: 'Items',
    itemName: 'Item Name',
    quantity: 'Quantity',
    unit: 'Unit',
    category: 'Category',
    estimatedCost: 'Estimated Cost',
    justification: 'Justification',
    searchItemPlaceholder: 'Search or type item name...',
    addItem: '+ Add Item',
    cancel: 'Cancel',
    submitRequest: 'Submit Request',
    approve: 'Approve',
    reject: 'Reject',
    rejectionReasonPrompt: 'Please provide a reason for rejection:',
    update: 'Update',
    remove: 'Remove',
    logout: 'Logout',
    branch: 'Branch',
    branches: 'Branches',
    city: 'City',
    back: 'Back',
    email: 'Email Address',
    password: 'Password',
    login: 'Login',
    edit: 'Edit',
    save: 'Save',
    loginAs: 'Login As',
    returnToAdmin: 'Return to Admin Account',
    impersonationBanner: 'Logged in as {userName}. ',
    // Statuses
    'draft': 'Draft',
    'pending_hm_approval': 'Pending Hotel Manager',
    'pending_qs_approval': 'Pending Quality Supervisor',
    'pending_qm_approval': 'Pending Quality Manager',
    'pending_pa_approval': 'Pending Projects Accountant',
    'pending_fa_approval': 'Pending Final Approver',
    'pending_purchase': 'Pending Purchase',
    'pending_pm_approval': 'Pending Purchasing Manager',
    'pending_invoice': 'Pending Invoice',
    'pending_am_approval': 'Pending Accounting Manager',
    'pending_bank_rounds': 'Pending Bank Rounds',
    'completed': 'Completed',
    'rejected': 'Rejected',
    // Roles
    'hotel_manager': 'Hotel Manager',
    'quality_supervisor': 'Quality Supervisor',
    'quality_manager': 'Quality Manager',
    'projects_accountant': 'Projects Accountant',
    'final_approver': 'Final Approver',
    'purchasing_rep': 'Purchasing Representative',
    'purchasing_manager': 'Purchasing Manager',
    'accountant': 'Accountant',
    'accounting_manager': 'Accounting Manager',
    'bank_rounds_officer': 'Bank Rounds Officer',
    'auditor': 'Auditor',
    'admin': 'Administrator',
    // Dashboard & Details
    'noRequestsFound': 'No purchase requests found.',
    'requestDetails': 'Request Details',
    'approvalHistory': 'Approval History',
    'invoiceDetails': 'Invoice Details',
    'vendor': 'Vendor',
    'invoiceNumber': 'Invoice #',
    'invoiceDate': 'Invoice Date',
    'totalAmount': 'Total Amount',
    'processInvoice': 'Process Invoice',
    'supplierInformation': 'Supplier Information',
    'relevantSuppliers': 'Relevant Suppliers:',
    'contact': 'Contact',
    'noRequestSelected': 'No Request Selected',
    'selectRequestPrompt': 'Select a request from the list to view its details.',
    // Actions
    'submitted': 'submitted the request',
    'approved': 'approved the request',
    'markedAsPurchased': 'Marked as Purchased',
    'processedInvoice': 'processed the invoice',
    'bankRoundCompleted': 'completed the bank round',
    'completeBankRound': 'Complete Bank Round',
    // Invoice Upload
    'analyzeInvoice': 'Analyze Invoice',
    'aiInvoiceAnalysis': 'AI Invoice Analysis',
    'duplicateCheck': 'Duplicate Check',
    'potentialDuplicateFound': 'Potential duplicate found.',
    'noDuplicateFound': 'No duplicate found.',
    'priceVerification': 'Price Verification',
    'confirmAndProceed': 'Confirm & Proceed',
    'attachments': 'Attachments',
    'attachFile': 'Attach File',
    'uploadedBy': 'Uploaded by {name} on {date}',
    'confirmDeleteAttachment': 'Are you sure you want to delete this attachment?',
    // Price Catalog Logic
    'internalPriceCheckTitle': 'Price Comparison with Catalog',
    'priceHigherWarning': 'Warning: Some prices are higher than last recorded prices.',
    'priceLowerOrSameInfo': 'Prices are within or below recorded catalog prices.',
    'internalPriceCheck.higher': 'Warning: Higher than catalog price of SAR {catalogPrice}.',
    'internalPriceCheck.lower': 'Info: Lower than catalog price of SAR {catalogPrice}. Catalog will be updated.',
    'internalPriceCheck.new': 'Info: New item not found in catalog.',
    'internalPriceCheck.same': 'Price matches catalog.',
    'toast.catalogUpdated': 'Price catalog updated successfully!',
    'toast.loginAsSuccess': 'Successfully logged in as {userName}.',
    'toast.revertedToAdmin': 'Returned to your Administrator account.',
    // New Request Form
    'createNewRequest': 'Create New Purchase Request',
    'department': 'Department',
    'projects': 'Projects',
    'housekeeping': 'Housekeeping',
    'maintenance': 'Maintenance',
    'f&b': 'F&B',
    'management': 'Management',
    'saveDraft': 'Save Draft',
    'getSupplierSuggestions': 'Get AI Supplier Suggestions',
    'aiSupplierSuggestions': 'AI Supplier Suggestions',
    'generatingSuggestions': 'Generating suggestions...',
    'toast.draftSaved': 'Draft saved successfully!',
    'toast.loginSuccess': 'Login successful! (Confirmation simulated)',
    // Settings
    'settings': 'Settings',
    'language': 'Language',
    'userManagement': 'User Management',
    'roleManagement': 'Role Management',
    'branchManagement': 'Branch Management',
    'addBranch': 'Add Branch',
    'userName': 'User Name',
    'role': 'Role',
    'addUser': 'Add User',
    'addRole': 'Add Role',
    'permissions': 'Permissions',
    'toast.settingsUpdated': 'Settings updated successfully!',
    // Supplier Management
    'supplierManagement': 'Supplier Management',
    'addSupplier': 'Add Supplier',
    'supplierName': 'Supplier Name',
    'salesRepresentatives': 'Sales Representatives',
    'addRepresentative': 'Add Representative',
    'repName': 'Representative\'s Name',
    'repContact': 'Representative\'s Contact',
    'toast.supplierRepAdded': 'Added new representative {repName} for {vendorName}.',
    'website': 'Website',
    'notes': 'Notes',
    // Reports Modal
    'reports': 'Reports',
    'monthlyReports': 'Monthly Reports',
    'selectBranch': 'Select Branch',
    'selectMonth': 'Select Month',
    'generateReport': 'Generate Report',
    'generatingReport': 'Generating report, please wait...',
    'aiAnalysis': 'AI Analysis',
    'totalSpend': 'Total Spend',
    'totalRequests': 'Total Requests',
    'breakdownByDepartment': 'Breakdown by Department',
    'spendingByDepartment': 'Spending by Department',
    'sendViaEmail': 'Send via Email',
    'enterEmailPlaceholder': 'Enter email address...',
    'keyMetrics': 'Key Metrics',
    'emailSubject': 'Monthly Expense Report for {branchName} - {month}',
    'emailGreeting': 'Hello,',
    'emailIntro': 'Please find the attached monthly expense report for {branchName} for the period of {month}.',
    'emailClosing': 'Best regards,',
    'toast.emailClientOpened': 'Your email client has been opened.',
    // Kanban
    'kanban.draft': 'Draft',
    'kanban.pendingApproval': 'Pending Approval',
    'kanban.inProgress': 'In Progress',
    'kanban.completed': 'Completed',
    'kanban.rejected': 'Rejected',
    // Filter Bar
    'searchRequests': 'Search by Ref #, ID, requester, or item...',
    'filterByBranch': 'Filter by Branch',
    'filterByDepartment': 'Filter by Department',
    'allBranches': 'All Branches',
    'allDepartments': 'All Departments',
    'clearFilters': 'Clear Filters',
    'kanbanView': 'Kanban View',
    'listView': 'List View',
    // Analytics
    'analytics.awaitingMyAction': 'Awaiting My Action',
    'analytics.totalPendingSpend': 'Total Pending Spend',
    'analytics.overpricedItems': 'Overpriced Items (AI)',
    'analytics.completedThisMonth': 'Completed This Month',
    // AI Chat
    'aiAssistant': 'AI Assistant',
    'askMeAnything': 'Ask me anything about your requests...',
    'aiSearchPlaceholder': 'e.g., "Show me pending requests in Riyadh"',
    'aiGreeting': 'Hello! I am your procurement assistant. How can I help you find a request today?',
    // Errors
    'loginError': 'Invalid email or password. Please try again.',
    'error.selectInvoice': 'Please select an invoice file to analyze.',
    'error.failedAnalysis': 'Failed to analyze the invoice. Please try again.',
    'error.cannotDeleteSelf': 'You cannot delete your own user account.',
    'error.cannotDeleteAdminRole': 'The Administrator role cannot be deleted.',
    'error.roleInUse': 'Cannot delete role as it is currently assigned to users.',
    'error.branchInUse': 'Cannot delete branch as it is currently assigned to users or requests.',
    'error.noRequestsForPeriod': 'No completed requests found for the selected branch and period.',
    'error.reportGenerationFailed': 'Failed to generate the report. Please try again.',
    'error.enterEmail': 'Please enter a valid email address.',
    'error.suggestionFailed': 'Could not generate supplier suggestions. Please try again.',
  },
  ar: {
    // General
    appTitle: 'نظام المشتريات',
    shortAppTitle: 'فنادق إيواء',
    selectRole: 'الرجاء تحديد دورك لتسجيل الدخول',
    request: 'طلب',
    requests: 'طلبات',
    requester: 'مقدم الطلب',
    total: 'المجموع',
    currency: 'ريال سعودي',
    perUnit: 'للوحدة',
    items: 'الأصناف',
    itemName: 'اسم الصنف',
    quantity: 'الكمية',
    unit: 'الوحدة',
    category: 'الفئة',
    estimatedCost: 'التكلفة التقديرية',
    justification: 'المبرر',
    searchItemPlaceholder: 'ابحث أو اكتب اسم الصنف...',
    addItem: '+ إضافة صنف',
    cancel: 'إلغاء',
    submitRequest: 'إرسال الطلب',
    approve: 'موافقة',
    reject: 'رفض',
    rejectionReasonPrompt: 'يرجى تقديم سبب للرفض:',
    update: 'تحديث',
    remove: 'إزالة',
    logout: 'تسجيل الخروج',
    branch: 'الفرع',
    branches: 'الفروع',
    city: 'المدينة',
    back: 'رجوع',
    email: 'البريد الإلكتروني',
    password: 'كلمة المرور',
    login: 'تسجيل الدخول',
    edit: 'تعديل',
    save: 'حفظ',
    loginAs: 'الدخول كـ',
    returnToAdmin: 'العودة إلى حساب المدير',
    impersonationBanner: 'تم تسجيل الدخول باسم {userName}. ',
    // Statuses
    'draft': 'مسودة',
    'pending_hm_approval': 'بانتظار موافقة مدير الفندق',
    'pending_qs_approval': 'بانتظار مشرف الجودة',
    'pending_qm_approval': 'بانتظار مدير الجودة',
    'pending_pa_approval': 'بانتظار محاسب المشاريع',
    'pending_fa_approval': 'بانتظار الموافقة النهائية',
    'pending_purchase': 'بانتظار الشراء',
    'pending_pm_approval': 'بانتظار مدير المشتريات',
    'pending_invoice': 'بانتظار الفاتورة',
    'pending_am_approval': 'بانتظار مدير الحسابات',
    'pending_bank_rounds': 'بانتظار جولة البنك',
    'completed': 'مكتمل',
    'rejected': 'مرفوض',
    // Roles
    'hotel_manager': 'مدير الفندق',
    'quality_supervisor': 'مشرف الجودة',
    'quality_manager': 'مدير الجودة',
    'projects_accountant': 'محاسب المشاريع',
    'final_approver': 'الموافق النهائي',
    'purchasing_rep': 'مندوب مشتريات',
    'purchasing_manager': 'مدير المشتريات',
    'accountant': 'محاسب',
    'accounting_manager': 'مدير الحسابات',
    'bank_rounds_officer': 'مسؤول التحويلات البنكية',
    'auditor': 'مدقق',
    'admin': 'مدير النظام',
    // Dashboard & Details
    'noRequestsFound': 'لم يتم العثور على طلبات شراء.',
    'requestDetails': 'تفاصيل الطلب',
    'approvalHistory': 'سجل الموافقات',
    'invoiceDetails': 'تفاصيل الفاتورة',
    'vendor': 'المورد',
    'invoiceNumber': 'رقم الفاتورة',
    'invoiceDate': 'تاريخ الفاتورة',
    'totalAmount': 'المبلغ الإجمالي',
    'processInvoice': 'معالجة الفاتورة',
    'supplierInformation': 'معلومات المورد',
    'relevantSuppliers': 'الموردون ذوو الصلة:',
    'contact': 'اتصال',
    'noRequestSelected': 'لم يتم تحديد طلب',
    'selectRequestPrompt': 'حدد طلبًا من القائمة لعرض تفاصيله.',
    // Actions
    'submitted': 'قدم الطلب',
    'approved': 'وافق على الطلب',
    'markedAsPurchased': 'تم تأكيد الشراء',
    'processedInvoice': 'عالج الفاتورة',
    'bankRoundCompleted': 'أكمل جولة البنك',
    'completeBankRound': 'إكمال جولة البنك',
    // Invoice Upload
    'analyzeInvoice': 'تحليل الفاتورة',
    'aiInvoiceAnalysis': 'تحليل الفاتورة بالذكاء الاصطناعي',
    'duplicateCheck': 'التحقق من التكرار',
    'potentialDuplicateFound': 'تم العثور على تكرار محتمل.',
    'noDuplicateFound': 'لم يتم العثور على تكرار.',
    'priceVerification': 'التحقق من السعر',
    'confirmAndProceed': 'تأكيد ومتابعة',
    'attachments': 'المرفقات',
    'attachFile': 'إرفاق ملف',
    'uploadedBy': 'تم الرفع بواسطة {name} في {date}',
    'confirmDeleteAttachment': 'هل أنت متأكد من رغبتك في حذف هذا المرفق؟',
    // Price Catalog Logic
    'internalPriceCheckTitle': 'مقارنة الأسعار مع الكتالوج',
    'priceHigherWarning': 'تنبيه: بعض الأسعار أعلى من آخر سعر مسجل.',
    'priceLowerOrSameInfo': 'الأسعار ضمن أو أقل من أسعار الكتالوج المسجلة.',
    'internalPriceCheck.higher': 'تنبيه: أعلى من سعر الكتالوج {catalogPrice} ريال.',
    'internalPriceCheck.lower': 'معلومة: أقل من سعر الكتالوج {catalogPrice} ريال. سيتم تحديث الكتالوج.',
    'internalPriceCheck.new': 'معلومة: صنف جديد غير موجود في الكتالوج.',
    'internalPriceCheck.same': 'السعر يطابق سعر الكتالوج.',
    'toast.catalogUpdated': 'تم تحديث كتالوج الأسعار بنجاح!',
    'toast.loginAsSuccess': 'تم تسجيل الدخول بنجاح باسم {userName}.',
    'toast.revertedToAdmin': 'تمت العودة إلى حساب المدير الخاص بك.',
    // New Request Form
    'createNewRequest': 'إنشاء طلب شراء جديد',
    'department': 'القسم',
    'projects': 'المشاريع',
    'housekeeping': 'التدبير المنزلي',
    'maintenance': 'الصيانة',
    'f&b': 'الأغذية والمشروبات',
    'management': 'الإدارة',
    'saveDraft': 'حفظ كمسودة',
    'getSupplierSuggestions': 'الحصول على اقتراحات الموردين بالذكاء الاصطناعي',
    'aiSupplierSuggestions': 'اقتراحات الموردين بالذكاء الاصطناعي',
    'generatingSuggestions': 'جاري إنشاء الاقتراحات...',
    'toast.draftSaved': 'تم حفظ المسودة بنجاح!',
    'toast.loginSuccess': 'تم تسجيل الدخول بنجاح! (محاكاة التأكيد)',
    // Settings
    'settings': 'الإعدادات',
    'language': 'اللغة',
    'userManagement': 'إدارة المستخدمين',
    'roleManagement': 'إدارة الأدوار',
    'branchManagement': 'إدارة الفروع',
    'addBranch': 'إضافة فرع',
    'userName': 'اسم المستخدم',
    'role': 'الدور',
    'addUser': 'إضافة مستخدم',
    'addRole': 'إضافة دور',
    'permissions': 'الصلاحيات',
    'toast.settingsUpdated': 'تم تحديث الإعدادات بنجاح!',
    // Supplier Management
    'supplierManagement': 'إدارة الموردين',
    'addSupplier': 'إضافة مورد',
    'supplierName': 'اسم المورد',
    'salesRepresentatives': 'مناديب المبيعات',
    'addRepresentative': 'إضافة مندوب',
    'repName': 'اسم المندوب',
    'repContact': 'رقم المندوب',
    'toast.supplierRepAdded': 'تمت إضافة مندوب جديد {repName} للمورد {vendorName}.',
    'website': 'الموقع الإلكتروني',
    'notes': 'ملاحظات',
    // Reports Modal
    'reports': 'التقارير',
    'monthlyReports': 'التقارير الشهرية',
    'selectBranch': 'اختر الفرع',
    'selectMonth': 'اختر الشهر',
    'generateReport': 'إنشاء تقرير',
    'generatingReport': 'جاري إنشاء التقرير، يرجى الانتظار...',
    'aiAnalysis': 'تحليل الذكاء الاصطناعي',
    'totalSpend': 'إجمالي المصروفات',
    'totalRequests': 'إجمالي الطلبات',
    'breakdownByDepartment': 'تفصيل حسب القسم',
    'spendingByDepartment': 'الإنفاق حسب القسم',
    'sendViaEmail': 'إرسال عبر البريد الإلكتروني',
    'enterEmailPlaceholder': 'أدخل عنوان البريد الإلكتروني...',
    'keyMetrics': 'المقاييس الرئيسية',
    'emailSubject': 'تقرير المصاريف الشهري لـ {branchName} - {month}',
    'emailGreeting': 'مرحباً،',
    'emailIntro': 'تجدون طيه تقرير المصاريف الشهري لـ {branchName} عن فترة {month}.',
    'emailClosing': 'مع أطيب التحيات،',
    'toast.emailClientOpened': 'تم فتح برنامج البريد الإلكتروني الخاص بك.',
    // Kanban
    'kanban.draft': 'مسودة',
    'kanban.pendingApproval': 'بانتظار الموافقة',
    'kanban.inProgress': 'قيد التنفيذ',
    'kanban.completed': 'مكتمل',
    'kanban.rejected': 'مرفوض',
    // Filter Bar
    'searchRequests': 'ابحث بالرقم المرجعي، الرقم التعريفي، مقدم الطلب، أو الصنف...',
    'filterByBranch': 'تصفية حسب الفرع',
    'filterByDepartment': 'تصفية حسب القسم',
    'allBranches': 'كل الفروع',
    'allDepartments': 'كل الأقسام',
    'clearFilters': 'مسح الفلاتر',
    'kanbanView': 'عرض كانبان',
    'listView': 'عرض القائمة',
    // Analytics
    'analytics.awaitingMyAction': 'بانتظار إجراء مني',
    'analytics.totalPendingSpend': 'إجمالي المصروفات المعلقة',
    'analytics.overpricedItems': 'أصناف بأسعار مبالغ فيها (AI)',
    'analytics.completedThisMonth': 'طلبات مكتملة هذا الشهر',
    // AI Chat
    'aiAssistant': 'المساعد الذكي',
    'askMeAnything': 'اسألني أي شيء عن طلباتك...',
    'aiSearchPlaceholder': 'مثال: "أظهر لي الطلبات المعلقة في الرياض"',
    'aiGreeting': 'مرحباً! أنا مساعد المشتريات الخاص بك. كيف يمكنني مساعدتك في العثور على طلب اليوم؟',
    // Errors
    'loginError': 'البريد الإلكتروني أو كلمة المرور غير صحيحة. يرجى المحاولة مرة أخرى.',
    'error.selectInvoice': 'الرجاء تحديد ملف فاتورة لتحليله.',
    'error.failedAnalysis': 'فشل تحليل الفاتورة. الرجاء المحاولة مرة أخرى.',
    'error.cannotDeleteSelf': 'لا يمكنك حذف حساب المستخدم الخاص بك.',
    'error.cannotDeleteAdminRole': 'لا يمكن حذف دور مدير النظام.',
    'error.roleInUse': 'لا يمكن حذف الدور لأنه معين حالياً للمستخدمين.',
    'error.branchInUse': 'لا يمكن حذف الفرع لأنه معين حالياً للمستخدمين أو الطلبات.',
    'error.noRequestsForPeriod': 'لم يتم العثور على طلبات مكتملة للفرع والفترة المحددة.',
    'error.reportGenerationFailed': 'فشل إنشاء التقرير. الرجاء المحاولة مرة أخرى.',
    'error.enterEmail': 'الرجاء إدخال عنوان بريد إلكتروني صالح.',
    'error.suggestionFailed': 'تعذر إنشاء اقتراحات الموردين. يرجى المحاولة مرة أخرى.',
  },
};

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

// FIX: Rewrote JSX return to use React.createElement. This is necessary because the file is a .ts file,
// not a .tsx file, and therefore does not support JSX syntax directly. This change resolves the parsing errors.
export const LanguageProvider: FC<{ children: ReactNode }> = ({ children }) => {
  const [language, setLanguage] = useState<Language>('ar');

  const t = (key: string, options?: Record<string, string | number>): string => {
    let translation = translations[language][key] || key;
    if (options) {
      Object.keys(options).forEach(k => {
        translation = translation.replace(`{${k}}`, String(options[k]));
      });
    }
    return translation;
  };

  return React.createElement(
    LanguageContext.Provider,
    { value: { language, setLanguage, t } },
    children
  );
};

export const useTranslation = () => {
  const context = useContext(LanguageContext);
  if (context === undefined) {
    throw new Error('useTranslation must be used within a LanguageProvider');
  }
  return context;
};